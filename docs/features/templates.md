# テンプレートシステム

## 広告テンプレートシステム

### 主要機能

- **HTMLエディター**: Monaco Editor による高機能コードエディター
- **プレースホルダーシステム**: `{{variableName}}` 形式の動的コンテンツ対応
- **バリデーション**: HTMLとプレースホルダーの整合性チェック
- **SEO対応**: 自動 `rel="nofollow"` 属性追加・削除機能
- **CSV インポート/エクスポート**: テンプレートの一括管理機能、詳細な結果表示
- **高度な検索・フィルタリング**: テンプレート名・説明・プレースホルダーでの検索機能
- **タイムスタンプ表示**: テンプレート作成・更新日時のリアルタイム表示（日本時間対応）
- **テンプレート整合性監視**: テンプレート変更時の影響分析と既存コンテンツとの整合性チェック
- **レスポンシブレイアウト**: 全デバイス対応の最適化されたカードレイアウト

### HTMLコードエディター機能

- **シンタックスハイライト**: HTML専用カラーテーマ
- **オートコンプリート**: タグとプロパティの自動補完
- **コードフォーマット**: ワンクリックでの整形機能
- **バリデーション**: リアルタイムエラーチェック
- **プレースホルダー表示**: 未入力時のガイド表示

### プレースホルダーバリデーション

- **命名規則チェック**: 推奨キーワードベースの命名規則
- **整合性確認**: HTMLとプレースホルダーリストの一致確認
- **自動修正機能**: 不整合の自動検出と修正提案

### システム構成

テンプレートシステムは以下のコンポーネントで構成されています：

- **テンプレート検証**: `src/lib/template-utils/validation.ts` - HTMLとプレースホルダーの構造検証
- **プレースホルダー抽出**: `src/lib/template-utils/placeholder-extraction.ts` - `{{variable}}` 形式のプレースホルダーをHTMLから抽出
- **リンク処理**: `src/lib/template-utils/link-processing.ts` - SEO用の `rel="nofollow"` 属性処理
- **テンプレートアクション**: `src/lib/template-actions.ts` - 認証チェック付きのテンプレートCRUD操作
- **HTMLエディター**: `src/components/HTMLCodeEditor.tsx` - Monaco EditorによるHTMLシンタックスハイライト
- **テンプレートフック**: `src/app/ad-templates/hooks/useTemplates.tsx` - テンプレートの状態管理

テンプレートは `{{variableName}}` 形式での動的プレースホルダーをサポートし、SEO対応のため外部リンクに自動的に
`rel="nofollow"` を適用します。

### CSV機能

アプリケーションには包括的なCSVインポート/エクスポート機能が実装されています：

- **CSV処理**: `src/lib/csv-utils.ts` - 引用符フィールドと複数行値をサポートした堅牢なCSV解析
- **インポート/エクスポートフック**: `src/hooks/useImportExport.tsx` - インポート/エクスポートの状態管理
- **共通コンポーネント**: `src/components/ImportExportButtons.tsx` - 一貫したUI提供
- **結果処理**: `ImportResult` インターフェースによる詳細フィードバック（成功数、エラー、アイテム詳細）
- **バッチ処理**: インポート時の作成・更新・スキップ機能と詳細エラーレポート
- **ファイル形式検証**: CSV形式検証とエラーメッセージ、フォーマットガイダンス

### サンプルテンプレート

シードスクリプトでは以下の就活向けテンプレートが作成されます：

- **就活支援バナー** - 基本的なグラデーション背景バナー
- **大型就活バナー** - インパクトのある大型バナー
- **就活テキスト広告** - シンプルなテキストのみの広告
- **就活サービスカード** - 画像とロゴ付きカード形式
- **記事内就活インライン** - 記事に自然に溶け込むインライン広告
- **記事内就活カード** - 記事内挿入用カード型広告
- **就活リボン型** - 特殊形状のリボンデザイン
- **就活アイコン広告** - 円形アイコンを使った横長デザイン

## URLテンプレートシステム

### 主要機能

- **UTMパラメータ管理**: 標準的なUTMトラッキングパラメータ（source、medium、campaign、term、content）の完全サポート
- **カスタムパラメータ**: JSON形式でのカスタムトラッキングパラメータ対応
- **テンプレート有効化**: ブール値フラグによるURLテンプレートの有効・無効制御
- **URL生成**: ベースURLとパラメータの組み合わせによる完全なトラッキングURL生成
- **バリデーション**: URL形式とパラメータ整合性の検証機能
- **独立した検索・フィルタリング**: URLテンプレート名・説明・パラメータでの専用検索機能
- **CSV インポート/エクスポート**: URLテンプレートの一括管理機能、詳細な結果表示

### URLテンプレート管理機能

- **CRUD操作**: URLテンプレートの作成・読み取り・更新・削除
- **UTMパラメータ設定**: キャンペーン別のトラッキングパラメータ管理
- **プレビュー機能**: 生成されるトラッキングURLのリアルタイムプレビュー
- **テンプレート一覧**: カード形式での直感的なテンプレート管理
- **フィルタリング**: アクティブ・非アクティブテンプレートの切り替え表示

### システム構成

URLテンプレートシステムは包括的なトラッキングパラメータ管理を提供します：

- **URLテンプレート管理**: `src/lib/url-template-actions.ts` - 認証チェック付きのURLテンプレートCRUD操作
- **UTMパラメータサポート**: 包括的なUTMトラッキング（source、medium、campaign、term、content）
- **カスタムパラメータ**: 高度なトラッキング用JSONベースのカスタムパラメータ保存
- **テンプレート検証**: URL形式検証とパラメータ整合性チェック
- **URLテンプレートフック**: `src/app/url-templates/hooks/useUrlTemplates.tsx` - URLテンプレートの状態管理
- **UIコンポーネント**: `UrlTemplateCard.tsx`、`UrlTemplateForm.tsx`、`UrlTemplateClient.tsx` による完全なCRUDインターフェース
- **テンプレート有効化**: URLテンプレートの有効・無効を制御するブール値フラグシステム

URLテンプレートは標準的なUTMパラメータとカスタムJSONパラメータの両方をサポートし、柔軟なキャンペーン追跡とアナリティクス統合を実現します。

### サンプルURLテンプレート

シードスクリプトでは以下のURLテンプレートが作成されます：

- **就活サイト基本URL** - PORTキャリア向け基本トラッキング
- **キャンペーン専用URL** - 特定キャンペーン用UTMパラメータ付き
- **SNS投稿用URL** - ソーシャルメディア投稿用カスタムパラメータ付き
- **メール配信用URL** - メールマーケティング用トラッキング
- **広告配信用URL** - 広告プラットフォーム別トラッキング

## テンプレート整合性システム

### 主要機能

- **変更影響分析**: テンプレート変更時の既存コンテンツへの影響を事前に分析
- **整合性チェック**: プレースホルダーの不整合や孤立したコンテンツを検出
- **重要度分類**: critical、warning、infoレベルでの問題分類
- **ダッシュボード統合**: リアルタイムでのシステム健全性表示
- **自動警告**: テンプレート更新前のブレーキングチェンジ警告

### システム構成

高度なテンプレート整合性監視システム：

- **整合性チェッカー**: `src/lib/consistency-checker.ts` - テンプレート変更とそれが既存コンテンツに与える影響の包括的分析
- **変更分析**: `analyzeTemplateChanges()` - プレースホルダーの違いを検出し、影響を受ける広告コンテンツを特定
- **URLテンプレート分析**: `analyzeUrlTemplateChanges()` - URLパラメータ変更とコンテンツ依存関係の追跡
- **整合性監視**: `getSystemIntegrityStatus()` - 重要度分類によるシステム全体のヘルスチェック
- **APIエンドポイント**: `/api/integrity-check` - テンプレート整合性検証用REST API
- **ダッシュボード統合**: `IntegrityMonitor.tsx` - ダッシュボードでのリアルタイム整合性ステータス表示
- **テンプレート変更警告**: `TemplateChangeWarning.tsx`、`UrlTemplateChangeWarning.tsx` - テンプレート更新前の破壊的変更の警告

整合性システムは問題を重要度（critical、warning、info）で分類し、以下を含む詳細な影響分析を提供します：

- テンプレートとコンテンツ間のプレースホルダー不整合
- 削除されたテンプレートを持つ孤立したコンテンツ
- 欠落または未使用のプレースホルダー
- 広告テンプレートとURLテンプレート間のパラメータマッピング競合

### テンプレート同期システム

テンプレート変更時のデータ整合性を維持するための高度なシステム：

- **変更検出**: 新旧テンプレートバージョン間のプレースホルダー違いの自動分析
- **コンテンツ移行**: テンプレート変更時の広告コンテンツからの孤立プレースホルダーデータの自動削除
- **整合性警告**: 専用UIコンポーネントによる修正前の影響分析とユーザー警告
- **同期API**: バッチコンテンツ更新用のテンプレートとURLテンプレート同期エンドポイント
- **警告コンポーネント**: `TemplateChangeWarning.tsx`、`UrlTemplateChangeWarning.tsx` によるユーザー通知

### 技術的特徴

- **リアルタイム監視**: プレースホルダーミスマッチの即座な検出
- **パラメータマッピング**: 広告テンプレートとURLテンプレート間の自動関連付け
- **標準UTMパラメータサポート**: utm_source、utm_medium等の標準パラメータ対応
- **JSON設定サポート**: カスタムパラメータの柔軟な管理
