# 広告管理・配信システム

## 広告コンテンツ管理システム

### 主要機能

- **画像アップロード**: Vercel Blobを使用したドラッグ&ドロップ対応画像アップロード機能
- **ステータス管理**: 下書き・アクティブ・一時停止・アーカイブの4段階ワークフロー
- **プレビュー機能**: テンプレートとコンテンツデータを組み合わせたリアルタイムプレビュー
- **プレースホルダー対応**: テンプレートのプレースホルダーと画像・コンテンツの動的結合
- **URLテンプレート連携**: URLテンプレートを使用したトラッキングURL生成
- **CRUD操作**: 広告コンテンツの作成・読み取り・更新・削除

### 広告コンテンツワークフロー

1. **下書き作成**: テンプレート選択、コンテンツデータ入力、画像アップロード
2. **プレビュー確認**: リアルタイムでの広告表示確認
3. **アクティブ化**: 審査後の公開状態への移行
4. **運用管理**: ステータス変更、コンテンツ更新、効果測定

### システム構成

広告コンテンツ管理システムは画像処理を含む包括的な広告作成・管理機能を提供します：

- **広告コンテンツ管理**: `src/lib/ad-content-actions.ts` - 認証チェック付きの広告コンテンツCRUD操作
- **画像アップロードシステム**: `src/components/ImageUpload.tsx` - ドラッグ&ドロップサポートとVercel
  Blob統合によるファイルアップロード処理
- **コンテンツデータ構造**: テンプレートとURLテンプレートに動的プレースホルダーサポート付きでリンクするJSONベースのコンテンツ保存
- **ステータス管理**: 広告ライフサイクル管理のための4ステートワークフロー（下書き、アクティブ、一時停止、アーカイブ）
- **画像関連付け**: 動的コンテンツ挿入のための広告テンプレート内の特定のプレースホルダー名への画像のリンク
- **広告コンテンツフック**: `src/app/ads/hooks/useAdContents.tsx` - 広告コンテンツの状態管理
- **UIコンポーネント**: `AdContentCard.tsx`、`AdContentForm.tsx`、`AdPreview.tsx`、`AdContentClient.tsx` による完全なCRUDインターフェース
- **ファイルストレージ**: メタデータ追跡付きスケーラブル画像ホスティング用のVercel Blob統合

広告コンテンツはテンプレート、URLテンプレート、ユーザーアップロード画像を組み合わせて完全な広告インスタンスを作成し、包括的な追跡とプレビュー機能を提供します。

### 技術的特徴

- **Vercel Blob**: スケーラブルな画像ストレージサービス
- **型安全性**: TypeScriptによる厳格な型定義
- **認可制御**: ロールベースでの作成・編集権限管理
- **エラーハンドリング**: 包括的なバリデーションとエラー処理

## 広告配信システム

### 主要機能

- **WordPress連携**: ショートコード `[lmg_ad id="123"]` による簡単な広告埋め込み
- **外部配信API**: CORS対応の広告配信エンドポイント
- **インプレッション追跡**: 広告表示時の自動カウント機能
- **クリック追跡**: 透過的なリダイレクト機能によるクリック数計測
- **キャッシュ最適化**: 5分間のキャッシュヘッダー設定

### WordPress統合

WordPressサイトでの広告表示は以下のショートコードを使用：

```php
[lmg_ad id="123"]                     // 基本形
[lmg_ad id="123" class="my-ad"]       // CSSクラス指定
[lmg_ad id="123" cache="300"]         // キャッシュ時間指定（秒）
```

### システム構成

主にWordPressサイト向けのカスタムショートコードを使用する洗練された広告配信システム：

#### 配信API

- **配信エンドポイント**: `/api/delivery/[id]` - インプレッション追跡付きの処理済み広告HTML配信
- **クリック追跡**: `/api/delivery/[id]/click` - クリック追跡と元URLへのリダイレクト処理
- **CORS有効化**: 適切なヘッダーによるWordPress統合のためのフルクロスオリジンサポート
- **キャッシュ**: パフォーマンス最適化のための5分間キャッシュヘッダー
- **自動リンク変換**: アナリティクス用の外部リンクの自動追跡URL変換

#### WordPress統合

- **ショートコードシステム**: WordPressコンテンツでの簡単な埋め込み用 `[lmg_ad id="123"]` 形式
- **柔軟な属性**: キャッシュ時間、CSSクラス、寸法、スタイリングオプションのサポート
- **配信コードモーダルコンポーネント**: WordPress統合ガイド付きコピー&ペーストショートコード生成インターフェース
- **デバッグモード**: 配信問題のトラブルシューティング用の組み込みデバッグ機能

#### アナリティクス追跡

- **インプレッション追跡**: データベース永続化による広告配信時の自動ビューカウント
- **クリック追跡**: リファラー保持による全外部リンクの透過的リダイレクト追跡
- **パフォーマンスメトリクス**: 包括的アナリティクス用のインプレッション、クリック、最終アクセス時間の追跡
- **データベースフィールド**: 追跡用の `ad_contents` テーブル内の `impressions`、`clicks`、`last_accessed_at` カラム

### 技術的特徴

- **自動リンク変換**: 外部リンクを追跡URLに自動変換
- **パフォーマンス最適化**: CDNフレンドリーなキャッシュ設定
- **エラーハンドリング**: 広告が見つからない場合の適切な処理
- **デバッグモード**: 開発・テスト用のデバッグ機能

## 画像管理・クリーンアップシステム

### 主要機能

- **自動削除機能**: 広告コンテンツ削除時の関連画像連鎖削除
- **孤立画像検出**: 削除されたコンテンツに紐づく画像の自動検出
- **古い未使用画像削除**: 長期間下書き状態の画像の定期削除
- **Vercel Cron Jobs**: 毎週日曜日2時の自動クリーンアップ実行

### システム構成

画像管理システムは以下のコンポーネントで構成されています：

- **画像クリーンアップシステム**: `src/lib/image-cleanup.ts` - 孤立した画像と古い未使用画像の自動クリーンアップ
- **画像ユーティリティ**: `src/lib/image-utils.ts` - 画像処理とコンテンツデータ操作のための共通ヘルパー関数
- **自動クリーンアップ**: 広告コンテンツ削除時の画像の包括的削除、加えて古い下書き画像の定期クリーンアップ
- **Vercel Cron Jobs**: システムメンテナンスのための週次クリーンアップ実行（日曜日午前2時UTC）

### 技術的特徴

- **完全自動化**: 運用負荷ゼロの画像管理システム
- **エラーハンドリング**: 個別画像削除失敗の全体処理への影響なし
- **詳細ログ**: クリーンアップ実行結果の包括的ログ出力

### 自動クリーンアップ設定

`vercel.json`でCronJobsを設定：

```json
{
  "crons": [
    {
      "path": "/api/admin/cleanup-images",
      "schedule": "0 2 * * 0"
    }
  ]
}
```

環境変数`CRON_SECRET`でCron認証を設定。
